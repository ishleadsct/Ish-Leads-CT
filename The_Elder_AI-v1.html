cat > index.html << 'EOF'
<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Elder</title>
    <style>
        :root {
            --bg-color: #1a1a1a; --panel-bg-color: #242424; --dashboard-bg-url: '';
            --console-bg-url: ''; --text-color: #e0e0e0; --text-secondary-color: #a0a0a0;
            --border-color: #3a3a3a; --accent-color: #588F5A; --accent-color-hover: #6BA46D;
            --console-button-color: #6a4c93; --font-family: 'SF Mono', 'Consolas', 'Menlo', monospace;
        }
        html, body { height: 100%; margin: 0; overflow: hidden; }
        body { background-color: var(--bg-color); color: var(--text-color); font-family: var(--font-family); }
        #app-container { display: flex; flex-direction: column; height: 100%; }
        #top-bar { padding: 0.75rem 1rem; border-bottom: 1px solid var(--border-color); text-align: center; font-size: 1.2rem; font-weight: bold; background-color: var(--panel-bg-color); }
        #dashboard { flex-grow: 1; display: flex; flex-direction: column; background-image: var(--dashboard-bg-url); background-size: cover; background-position: center; overflow: hidden; position: relative; }
        #chat-window { flex-grow: 1; overflow-y: auto; padding: 1rem; }
        .message { display: flex; margin-bottom: 1.5rem; max-width: 100%; }
        .message-avatar { width: 32px; height: 32px; border-radius: 50%; background-color: var(--panel-bg-color); text-align: center; line-height: 32px; font-weight: bold; margin-right: 1rem; flex-shrink: 0; }
        .message-content { padding-top: 6px; white-space: pre-wrap; word-break: break-word; }
        .message.user .message-avatar { border: 2px solid var(--accent-color); }
        .message.assistant .message-avatar { border: 2px solid var(--text-secondary-color); }
        #thinking-indicator { position: absolute; bottom: 7rem; left: 50%; transform: translateX(-50%); background-color: rgba(36, 36, 36, 0.8); backdrop-filter: blur(5px); padding: 0.5rem 1rem; border-radius: 6px; font-size: 0.9rem; opacity: 0; transition: opacity 0.3s ease-in-out; pointer-events: none; animation: pulse 2s infinite ease-in-out; }
        #thinking-indicator.visible { opacity: 1; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(88, 143, 90, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(88, 143, 90, 0); } 100% { box-shadow: 0 0 0 0 rgba(88, 143, 90, 0); } }
        #input-area { display: flex; padding: 1rem; border-top: 1px solid var(--border-color); flex-shrink: 0; background-color: rgba(22, 27, 34, 0.8); backdrop-filter: blur(5px); }
        #prompt-input { flex-grow: 1; background-color: var(--panel-bg-color); color: var(--text-color); border: 1px solid var(--border-color); border-radius: 6px; padding: 0.75rem; font-family: var(--font-family); font-size: 1rem; resize: none; }
        #send-button { background-color: var(--accent-color); color: white; border: none; border-radius: 6px; padding: 0 1.5rem; margin-left: 1rem; cursor: pointer; font-weight: bold; transition: background-color: 0.2s; }
        #bottom-bar { display: flex; padding: 0.5rem 1rem; border-top: 1px solid var(--border-color); background-color: var(--panel-bg-color); }
        #dev-console-button { background-color: var(--console-button-color); color: white; border: none; border-radius: 6px; font-size: 1.5rem; cursor: pointer; padding: 0.25rem 0.75rem; }
        #developer-console { position: fixed; bottom: 0; left: 0; right: 0; height: 50%; background-color: var(--panel-bg-color); background-image: var(--console-bg-url); background-size: cover; border-top: 2px solid var(--console-button-color); display: flex; flex-direction: column; padding: 1rem; transform: translateY(100%); transition: transform 0.3s ease-in-out; z-index: 100; }
        #developer-console.visible { transform: translateY(0); }
        #console-main { display: flex; flex-direction: column; flex-grow: 1; padding-top: 1rem; }
        #dev-code-input { flex-grow: 1; background-color: rgba(13, 17, 23, 0.9); color: var(--text-color); border: 1px solid var(--border-color); border-radius: 6px; padding: 0.75rem; font-family: var(--font-family); font-size: 0.9rem; resize: none; margin-bottom: 1rem; }
        #console-actions { display: flex; justify-content: flex-end; gap: 1rem; }
        #console-actions button { border: none; border-radius: 6px; padding: 0.75rem 1.5rem; cursor: pointer; font-weight: bold; font-family: var(--font-family); transition: transform 0.1s; }
        #console-actions button:active { transform: scale(0.98); }
        #save-knowledge-button { background-color: #306998; color: white; margin-right: auto; }
        #inject-button { background-color: var(--accent-color); color: white; }
        #clear-button { background-color: #555; color: var(--text-color); }
        .console-header { display: flex; justify-content: space-between; align-items: center; width: 100%; }
        #close-console-button { background: none; border: none; color: var(--text-secondary-color); font-size: 2rem; line-height: 1; cursor: pointer; padding: 0 0.5rem; }
        #close-console-button:hover { color: var(--text-color); }
    </style>
</head>
<body>
    <div id="app-container">
        <div id="top-bar">The Elder</div>
        <div id="dashboard">
            <div id="chat-window"></div>
            <div id="thinking-indicator"></div>
            <div id="input-area"><textarea id="prompt-input" rows="1" placeholder="Consult the oracle..."></textarea><button id="send-button">Send</button></div>
        </div>
        <div id="bottom-bar"><button id="dev-console-button" title="Open The Sacred Scroll">ðŸ“œ</button></div>
    </div>
    <div id="developer-console">
        <div class="console-header"><h2>ðŸ“œ The Sacred Scroll</h2><button id="close-console-button" type="button" title="Close Console">&times;</button></div>
        <div id="console-main">
            <textarea id="dev-code-input" placeholder="// To return a value, use 'return'. For example: return 2 + 2;"></textarea>
            <div id="console-actions">
                <button id="save-knowledge-button" title="Save conversation to a knowledge.json file">ðŸ’¾ Save Knowledge</button>
                <button id="inject-button">Inject & Execute</button>
                <button id="clear-button">Clear Code</button>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
    try {
        const LLM_SERVER_URL = 'http://localhost:8080';
        const LIBRARIAN_SERVER_URL = 'http://localhost:8081';
        
        const PERSONA_PROMPT = `You are The Elder, a wise, cryptic oracle. You have deep, general knowledge. You also have a 'search' tool for specific, real-world facts that you don't know (like weather or news). To use it, respond with a JSON object: {"tool": "search", "query": "your query"}. For all other questions, respond with natural language.`;
        const TOOL_USE_GRAMMAR = String.raw`root   ::= "{" ws "\"tool\"" ws ":" ws "\"search\"" ws "," ws "\"query\"" ws ":" ws string "}" ws
string ::= "\"" ( [^"\\] | "\\" (["\\/bfnrt] | "u" [0-9a-fA-F] [0-9a-fA-F] [0-9a-fA-F] [0-9a-fA-F]) )* "\""
ws ::= [ \t\n]*`;

        function needsSearchTool(text) {
            const lowerText = text.toLowerCase().trim();
            const keywords = ['weather', 'news', 'capital of', 'who is', 'what is the population of'];
            return keywords.some(kw => lowerText.includes(kw));
        }

        const devConsoleButton = document.getElementById('dev-console-button');
        const devConsolePanel = document.getElementById('developer-console');
        const chatWindow = document.getElementById('chat-window');
        const promptInput = document.getElementById('prompt-input');
        const sendButton = document.getElementById('send-button');
        const thinkingIndicator = document.getElementById('thinking-indicator');
        const saveKnowledgeButton = document.getElementById('save-knowledge-button');
        const closeConsoleButton = document.getElementById('close-console-button');

        let conversationHistory = []; // Start with a clean slate

        function addMessageToUI(sender, text) {
            const messageDiv = document.createElement('div'); messageDiv.className = `message ${sender}`;
            const avatarDiv = document.createElement('div'); avatarDiv.className = 'message-avatar'; avatarDiv.textContent = sender === 'user' ? 'You' : 'E';
            const contentDiv = document.createElement('div'); contentDiv.className = 'message-content'; contentDiv.textContent = text;
            messageDiv.appendChild(avatarDiv); messageDiv.appendChild(contentDiv);
            chatWindow.appendChild(messageDiv); chatWindow.scrollTop = chatWindow.scrollHeight;
        }

        function setThinking(state, text = '') {
            if (state) {
                thinkingIndicator.textContent = text; thinkingIndicator.classList.add('visible');
                promptInput.disabled = true; sendButton.disabled = true;
            } else {
                thinkingIndicator.classList.remove('visible'); promptInput.disabled = false;
                sendButton.disabled = false; promptInput.focus();
            }
        }
        
        async function handleUserPrompt() {
            const userText = promptInput.value.trim();
            if (userText === '') return;
            addMessageToUI('user', userText);
            promptInput.value = '';

            const lowerUserText = userText.toLowerCase();

            if (/\b(time|date)\b/.test(lowerUserText)) {
                const now = new Date();
                let responseText = '';
                if (lowerUserText.includes('date')) {
                    const dateOptions = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
                    responseText = `The scrolls mark this day as ${now.toLocaleDateString('en-US', dateOptions)}.`;
                } else {
                    const timeOptions = { hour: 'numeric', minute: '2-digit', timeZoneName: 'short' };
                    responseText = `The currents of time indicate it is currently ${now.toLocaleTimeString('en-US', timeOptions)}.`;
                }
                addMessageToUI('assistant', responseText);
                conversationHistory.push({ role: 'user', content: userText });
                conversationHistory.push({ role: 'assistant', content: responseText });
                return;
            }

            const userMessageForHistory = { role: 'user', content: userText };
            const currentTurnHistory = [{ role: 'system', content: PERSONA_PROMPT }, ...conversationHistory, userMessageForHistory];
            
            setThinking(true, 'The Elder is thinking...');
            try {
                const forceToolUse = needsSearchTool(userText);
                let response = await queryLlm(currentTurnHistory, forceToolUse ? TOOL_USE_GRAMMAR : null);
                
                let parsedResponse;
                try { parsedResponse = JSON.parse(response); } catch (e) { parsedResponse = null; }

                if (parsedResponse && parsedResponse.tool === 'search') {
                    setThinking(true, `Consulting the currents of time for: "${parsedResponse.query}"`);
                    const searchResults = await tool_Search(parsedResponse.query);
                    const followUpPromptHistory = [ ...currentTurnHistory, { role: 'assistant', content: JSON.stringify(parsedResponse) }, { role: 'user', content: `Here is the raw text from a web search: "${searchResults}". Synthesize this information into a natural, conversational response in your persona as The Elder.` }];
                    setThinking(true, 'The Elder is processing new knowledge...');
                    response = await queryLlm(followUpPromptHistory, null);
                }
                addMessageToUI('assistant', response);
                conversationHistory.push(userMessageForHistory);
                conversationHistory.push({ role: 'assistant', content: response });
            } catch (error) {
                addMessageToUI('assistant', `An error has occurred: ${error.message}`);
            } finally {
                setThinking(false);
            }
        }

        async function queryLlm(messages, grammar = null) {
            const payload = { prompt: formatChatML(messages), stream: false, n_predict: -1, temperature: 0.2, repeat_penalty: 1.1 };
            if (grammar) { payload.grammar = grammar; }
            const response = await fetch(`${LLM_SERVER_URL}/completion`, {
                method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            if (!response.ok) throw new Error(`LLM Server Error: ${response.status}`);
            const data = await response.json();
            return data.content.trim().replace(/<\|im_end\|>/g, '').replace(/<\|im_start\|>system[\s\S]*?<\|im_end\|>/g, '').trim();
        }

        async function tool_Search(query) {
            addMessageToUI('assistant', `ðŸ“œ The Librarian is searching for: "${query}"`);
            const response = await fetch(`${LIBRARIAN_SERVER_URL}/search?q=${encodeURIComponent(query)}`);
            if (!response.ok) throw new Error(`Librarian Server Error: ${response.status}`);
            const data = await response.json();
            return data.results;
        }

        function formatChatML(history) {
            let promptString = '';
            for (const message of history) { promptString += `<|im_start|>${message.role}\n${message.content}<|im_end|>\n`; }
            promptString += `<|im_start|>assistant\n`;
            return promptString;
        }

        function saveKnowledgeFile() {
            addMessageToUI('assistant', 'ðŸ“œ Transcribing the current knowledge to a scroll...');
            const knowledgeState = { conversationHistory: conversationHistory };
            const knowledgeString = JSON.stringify(knowledgeState, null, 2);
            const blob = new Blob([knowledgeString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = `knowledge.json`;
            document.body.appendChild(a); a.click();
            document.body.removeChild(a); URL.revokeObjectURL(url);
            addMessageToUI('assistant', 'A scroll of knowledge has been saved.');
        }
        
        const devConsolePassword = "TheElder$croll2025";
        devConsoleButton.addEventListener('click', () => {
            const p = prompt("The Scroll is sealed. Provide the password:");
            if (p === devConsolePassword) devConsolePanel.classList.toggle('visible');
            else if (p !== null) alert("Access Denied.");
        });
        closeConsoleButton.addEventListener('click', () => { devConsolePanel.classList.remove('visible'); });
        saveKnowledgeButton.addEventListener('click', saveKnowledgeFile);
        sendButton.addEventListener('click', handleUserPrompt);
        promptInput.addEventListener('keydown', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleUserPrompt(); } });

        addMessageToUI('assistant', 'The currents of time are swirling. What knowledge do you seek?');

    } catch (e) {
        console.error("A critical error occurred during initialization:", e);
        document.body.innerHTML = `<div style="color: red; padding: 2rem; font-family: monospace;"><h1>Critical Error</h1><p>The application failed to start.</p><pre>${e.stack}</pre></div>`;
    }
    });
    </script>
</body>
</html>
EOF
